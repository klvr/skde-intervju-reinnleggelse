# Oppgave til SKDE intervju: Reinnleggelse - Eksempeldata

Dette prosjektet er tiltenkt å fremvise arbeidsflyten underveis, samt diskutere noen av veivalgene
(og de alternative veiene) som ble tatt. Går mer i dybden på selve oppgaveløsningen, og ment for å
komplimentere produktet som blir presentert.

-   De mest åpenbare veivalgene som blir gjort blir merket "VEIVALG" i arbeidsflyten nedenfor.

-   Andre kommentarer blir merket "NOTAT".

-   <b>Postscript: Ble vel ambasiøst å løse oppgaven, og samtidig ha god nok tid til å holde dette 
prosjektet i en form som er respektabelt. Derfor høyst variabel kvalitet på "cleanness" på kode 
og ikke minst kommentering. Gir godt utgangspunkt for å lage ryddig og veldokumenter prosjekt senere :)</b>

## Prosjekt struktur:

    project/
    │   README.md                         - ReadMe file.
    |   README.html                       - Autogenerated html version of ReadMe.
    │   skde-intervju-reinnleggelse.Rproj - R project file.
    |   .gitignore                        - Default values + excludes data.
    │
    └───data/                             - Contains all data related files.
    │   │
    │   └───input/                        - All imported data are stored here. Treated as immutable.
    │   │   Eksempeldata.csv              - Imported data file.
    │   │
    │   └───processed/                    - All processed data files from scripts are saved here.
    │                                     - AUTO: This section will not be updated.
    │
    └───output/                           - Non-data files created from scripts and other products.
    |   Untitled.Rmd                      - Flexdashboard - Shiny combination file for dashboard.
    |   Untitled.html                     - Autogenetrated html version of dashboard.
    │
    └───src/                              - Contains all pure R scripts.
    |   |
    |   |checks_transformation.R          - Main script for EDA and data transformations.
    │   │
    │   └───functions/                    - All processed data files from scripts are saved here.
    │       Currently empty
    |
    └───WWW/                              - Folder for static products for use in dashboard.
        qr.jpg                            - Image file with QR code for this project.

# Arbeidsflyt

### 0 Oppsett

-   Lage GitHub repo

-   Laste ned lokalt til bruk som R prosjekt

-   Verfifisere at GitHub og RStudio kommuniserer begge veier

-   Lage / kopiere standard mappestruktur

-   Laste inn data

-   Legge data fil(er) til .gitignore

    -   VEIVALG: Som måtte blitt gjort med sensitive data.

-   Kunne brukt pakker som 'renv' for å sørge for at prosjektet har lenger/sikrere levetid

    -   VEIVALG: Dette skal leve i 4-7dager, så velger å ikke rote til prosjektet med dette nå.

### 1 Oppgave

#### 1.1 Oppgavetekst

Fra epost: "Se vedlagte datasett «Eksempeldata.csv» fra Norsk intensivregister. Presenter
kvalitetsindikatoren «Reinnleggelse». Visualiser, tolk og forklar den slik at en ikke-medisiner kan
lese og forstå presentasjonen. Du står helt fritt i hvilke verktøy du vil benytte til
visualisering/presentasjon".

#### 1.2 Variabel oversikt

Følgende variabler ble forklart i oppgaveteksten:

-   ReAdmitted: 1=ja, 2=nei
    
    - I processed data er dette endret til binære FALSE (nei) eller TRUE (ja)

-   PrimaryReasonAdmitted: 1=Respiratorisk svikt, 2=Sirk./kardiovaskulær svikt, 3=Gastroenterologisk
    svikt, 4=Nevrologisk svikt, 5=Sepsis, 6=Skade/traume, 7=Metabolsk/intoksikasjon, 8=Hematologisk
    svikt, 9=Nyresvikt, 10=Postoperativt eller 11=Annet

    -   NOTAT: Må undersøke hvor hyppig denne 11=Annet brukes.

-   PasientAge: Alder

    -   VEIVALG: I følge oppgaveteksten er alder tilfeldig fordelt, og jeg tolker dette som at de
        ikke er en meningsfylt simulering, og dermed bør ses bort i fra.

-   TypeOfAdmission: 0=planlagt, 6=akutt medisinsk eller 8=akutt kirurgisk

-   DischargedStatus: 0=i live eller 1=død

-   SykehusNavn: Hvilket sykehus dataene kommer fra.

    -   VEIVALG: For visualisering, har det ingenting å si om disse er helt tilfeldige, så i
        motsetning til alder velger jeg å ta dette med i oppgaveløsningen. Må selvsagt være klar
        over at dette fører til at man ikke får vurdert størrelse/kapasiteter/geografi etc. som man
        ville kunne sett på ved faktiske sykehus.

Følgende variabler ble ikke forklart i oppgaveteksten, mine tolkninger følger:

-   SkjemaID og PatientInRegistryID: ID variabler.

-   Respirator: Binær-variabel som forklarer om pasienten i løpet av oppholdet var på respirator
    eller ikke (basert på verdiene her sett sammen med numeriske 'Respirator'-variabelen).
    
    -   NOTAT: Denne kan være artig å bruke ved oppgaveløsning, må undersøkes nærmere.
    
    - I processed data er dette endret til binære FALSE (nei) eller TRUE (ja)

-   DateAdmitted, DateDischarged, DaysAdmitted: Når innleggelse fant sted, og lengde på inleggelsen.

    -   NOTAT: Her må spennet på datoer undersøkes, kan være dette vil være relevant dersom det ikke
        er et for kort tidsrom.

-   Respirator ('Respirator.1' ved innlasting, pga duplikat variabelnavn): Antall døgn på repirator
    for hver pasient (basert på at disse verdiene alltid er lavere enn DaysAdmitted).

    -   NOTAT: Basert på datoer for innleggelse, er disse dataene fra før COVID-19, og jeg vil
        dermed anta at respiratormangel/trykk ikke er et nevneverdig problem sammenliknet med senere
        / under pandemien. Og noe jeg ikke trenger å ta høyde for.

-   ChronicDiseases: Variabel med koder for kroniske lidelser.

    -   NOTAT: Dersom dette skal brukes, må jeg finne ut hva kodene er, da det er flere enn evt.
        ja/nei.

-   Saps2ScoreNumber: Numerisk skåre på Saps2, "Simplified Acute Physiology Score to predict
    hospital mortality". Basert på innholdet i denne samleskåren gir den rask helhetlig oversikt
    over hvor dårlig pasienten er.

-   Saps2Score: Standarisert variant av tallene over.

#### 1.3 Andre kilder

Eneste andre kilde som er brukt er [Norsk intensivregister - Årsrapport for 2018 med plan for
forbedringstiltak
v1.1](https://www.helse-bergen.no/4a967b/siteassets/seksjon/intensivregister/documents/arsrapporter/arsrapporter-i-nir/nir-arsrapport-2018.pdf).
Dette for å forstå konteksten bak registeret litt bedre.

Eksempeldatasettet er ikke identisk med dette, så direkte informasjon/tallmatriell derfra blir ikke
brukt.

To viktige punkter fra denne rapporten:

-   Hva/hvem registreres. Hva er kriteriene for å havne i NIR.

-   Mer detaljert hva kvalitetsvariabelen 'reinnleggelse' fanger opp.

##### 1.3.1 Hva/hvem havner i Norsk Intensivregister (NIR)

NIR er estimert til 97% overensstemmelse med lokale opplysninger, og har 82% dekning på
instutisjonsnivå. (s.6).

- NOTAT: Normalt sett, selv om dette er relativt god dekning, er det likevel nok som ikke blir 
    fanget opp til at det ville vært nyttig å se hvilke instutisjoner som ikke deltar. I denne
    oppgaven arbeider vi ikke med reelle sykehusnavn, så dette problemet utgår.

Følgende pasientopphold registreres i NIR (kortversjon; s. 84):

- Pasienter som ligger på intensiv/overvåkning i mer enn 24 timer.

- Pasienter som dør på intensiv/overvåkning.

- Pasienter som har fått mekanisk pustestøtte.

- Pasienter som har blitt overført til annen ressurs-/intensivavdeling.

- Pasienter som har fått kontinuerlig vasoaktiv infusjon over 6 timer, med invasiv blodtrykksmåling.

##### 1.3.2 Variabelforståelse 'reinnleggelse'

Reinnlegging er en variabel som fanger opp om pasienten ble reinnlagt til en intensivavdeling i 
løpet av 72 timer etter utskriving (s.16).

- VEIVALG: Selv om dette ikke står eksplisitt i oppgaven, velger jeg å anta/bruke samme definisjon
     i denne oppgaven.
     
- NOTAT: Basert på data, vil jeg tro dette inkluderer utskriving fra alle avdelinger. Flere 
innleggelser er merket som reinnleggelse, uten at pasientID eksisterer for mer enn en innleggelse. 
Dette gjelder også når dato for innleggelse er midt i den aktuelle perioden. Alternativt er 
eksempeldatasettet litt kuttet ned, uten å ta hensyn for dette.

Det er en målsetning er at det totale antallet reinleggelser ikke overstiger 4% av alle opphold 
(s. 85), og flere steder i rapporten brukes også denne målsetningen på instutisjonsnivå.

- VEIVALG: Velger å også bruke denne målsetting i oppgaveløsningen også.

#### 1.4 Oppgavetolkning

Som sett i pkt 1.1, er oppgaven svært fri. Kvalitetsvariabelen 'reinnleggelse' skal presenteres for 
et ikke-medisinsk publikum.

- VEIVALG: Jeg tar utgangspunkt i at jeg presenterer til en gruppe som har grovt kjennskap til 
helsesektoren, uten å være involvert i medisinsk arbeid. Videre tar jeg utgangspunkt i at denne 
gruppen har kjennskap til elementære statistiske mål og verktøy. F.eks.: En nyutdannet økonom med ny
 jobb ved et sykehus. Hen forstår "sepsis" hvis jeg forklarer det som blodforgiftning, vet litt om 
 hvordan et sykehus er organisert, og kjenner godt til median, og leser grafer uten problemer.
 
Videre vil valg av presentasjonsmetode kunne være avhengig av omgivelsene den skal gis i, samt 
hvordan den skal brukes videre. F.eks. vil et rapport (skriftlig PDF) format være nyttig dersom det 
er store mengder informasjon som skal leveres på kort tid, eller mange forskjellige aktører skal 
bruke produktet på et senere tidspunkt. En lysbilde presentasjon kan være nyttig dersom det 
presenteres for et stort publikum, som ikke skal arbeide svært direkte med produktet videre. Og et 
dashboard format kan være nyttig dersom det er en mindre gruppe / mer interaktiv gruppe.

- VEIVALG: Da denne gruppen er liten, og siden det tross alt er i intervju-sammenheng hvor Shiny 
ble nevnt i utlysningen, velger jeg dashboard formatet til denne presentasjonen (uten web hosting).

### 2 Initielle sjekker/oversikt, rydding og eksplorering

#### 2.1 Initiell oversikt
- Rask data oversikt: Hva jobber vi med?

- Inspisere data, med hovedfokus på variablene nevnt i oppgaveteksten. Missing data? Noe feil (
f.eks. '10' som verdi i en 0/1 binær variabel)? Min/max innenfor forventede verdier, eller noe 
ekstreme outliers? Her må man gå litt grundig til verks, for selv om man arbeider med relativt 
store data-mengder, er det likevel ganske få som blir reinnlagt, ganske mange årsaker til 
innleggelse, og ganske mange sykehus. Enkelte selekterte grupper kan dermed bli små, og selv litt 
data feil kan få store konsekvenser dersom disse feilene rammer skjevt.

- NOTAT: Eventuelle endringer/kommentarer gjøres samlet med pkt 2.2.

#### 2.2 Data rydding

- Er innlastet data teknisk korrekt? F.eks. numeric columns er satt til dette og ikke character. 

- Er alle variabler i et godt format, eller vil jeg endre på noen? F.eks. gjøre binære variabler til
 0 og 1 kan gjøre de enklere å jobbe med (tolket som TRUE / FALSE dersom de brukes direkte) fremfor 
 1 og 2 som må spesifiseres eller gjøres til faktorer.
 
 - Ønsker jeg å lage noen deriverte variabler?
 
 - Endre variabel-navn?
 
 - Andre endringer som er nyttig å gjøre på forhånd for _alt_ arbeid med dataene videre.
 
 - NOTAT: Dette gjøres i "src/checks_transformation.R". Jeg liker å samle alt slikt i et kort og 
 greit eget script. Dersom det videre blir flere scripts for å gjøre forskjellige ting, 
 ønsker jeg at de alle har samme utgangspunkt, og at eventuelle endringer da kun er "lokale" i de
 respektive scriptene. Fordelen med dette er at videre scripts blir så rene som mulig, samt av ved
 sammarbeid med andre så holder det at de får dette ene scriptet for å kunne replisere datasettet
 jeg arbeider med. Ulempen med dette er at de faktisk må kjøre dette scriptet før de forsøker å 
 kjøre andre jeg måtte dele. Alternativt kunne alle endringer blitt gjort der/når de trengs.
 Dette ville ført til mer duplisert kode, og litt mer rot, men sammarbeidspartnere vil da alltid
 kunne kjøre alle scripts, gitt at de også har behandlet orginal data som immutable.
 Begge varianter kan dermed være gode valg, og man velger hva som er hensiktsmessig utifra graden 
 av sam-jobbing / hvor hyppig og nært man arbeider med samme data. Med denne oppgaven arbeider jeg
 alene, så velger å ha eget clean-up script.
 
#### 2.3 Resultater og kommentarer

Overordnet gav EDA resultater som forventet. Svært lite manglende data, og gjennomgående solid data
matriell. Kun små justeringer ble gjort (se scriptet med kommentarer), og i all hovedsak relatert 
til struktur.

Noe mer utfordringer rundt linking av readmissions til orginale admission, men lot seg gjøre etter 
en god dose data wrangling og litt kreative løsninger.

Viktig derimot, er det å merke seg at de forskjellige "gruppene" ikke er jevnt fordelt. Det er store
forskjeller på hvor mye data / mange pasienter som kommer fra hvert sykehus. Store forskjeller i hva
som var årsaken til at de ble lagt inn, og type innleggelse (planlagt/medisinsk/kirurgisk). Videre 
og svært viktig for denne oppgaven, svært få pasienter er reinnleggelser.

Også verdt å nevne at det var 8281 unike pasienter over 10.000 innleggelser. 1261 av pasientene 
hadde flere innleggelser, helt opp til en med 11 innleggelser i den aktuelle perioden (ikke alle
innenfor kriteriene for 'reinnleggelse'). Flere hadde også gjentakende reinnleggelser. Begge disse
aspektene kan være viktig å ta tak i, og blir derfor laget to reduserte data sett. Ett som fanger
opp alle innleggelsene til de med flere innleggelser. Og ett som fanger opp alle innleggelsene til
de med minst en reinnleggelse.

Samlet sett gir dette godt grunnlag for spennende utforskning, og belyser også viktige aspekter 
å tenke over ved grafisk fremstilling. F.eks. bør mye av data her presenteres både som relative tall
og absolutte tall.

### 3 Planlegging av fremstilling av data matriell

I denne oppgaven er det spesielt fokus på kvalitetsmålet 'reinnleggelse', så det er her hovedvekten
vil ligge. Likevel er det nyttig å gi en overordnet oversikt, slik at man har en kontekst å forstå
reinnleggelse med.

#### 3.0 Meta introduksjon
- Hva er ikke med? ANALYSER!
- Relativt grov initiell oversikt over data matriellet.

#### 3.1 Introduksjon tema
- Holde dette på et ok kort nivå, da faktiske publikum er godt kjent med dette.

#### 3.2 Introduksjon data
- Data og variabler
- Absolutte tall
- Skillet mellom "innleggelser" og "pasienter"
- Caution: Tolkning på tvers av instutisjoner (irrelevant i denne med syntetiske sykehusnavn).

#### 3.3 Total oversikt
- Per sykehus for grafisk øvelse
- Grafer over nøkkelvariabler
- Store forskjeller i liggetider, respiratortider, dødlighet, må fremvises
- Alder(synt), liggetid, respiratordøgn, respiratorstøtte, overlevelse

#### 3.4 Reinnleggelse
- Grafer
- Død, tidspunkt, dato, årsak, type, sykehus

### 4 Oppgaveløsning
- Se egne scripts (med variabel kommentering..)

## Arbeidsnotater
-   Intro side til dashboard: Meta (link hit, og div info)

## Meta:
Liten teknisk ting: Analyser, frekventist vs. Baysiansk. Ser førstnevnte er nyttet i rapporten. Jeg 
ville muliggens valgt Baysiansk, spesielt til dette publikumet. Men kun nevneverdig dersom det gjøres
analyser og jeg er selvsagt veldig tilpasningsdyktig her :)
